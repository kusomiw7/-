<!DOCTYPE html>
<html lang="zh-Hant">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>Á®ãÂºèÁ¢ºÁâáÊÆµÂèñ‰ª£Â∑•ÂÖ∑ (V10.7 - ÂõõÂÄãÂª£ÂëäÂ∑≤ÂïüÁî®)</title>
   <!-- Load Tailwind CSS framework -->
   <script src="https://cdn.tailwindcss.com"></script>
   <!-- Configure Tailwind with Nord-inspired palette -->
   <script>
       // V10.7 - Nord Inspired Theme Configuration
       tailwind.config = {
           theme: {
               extend: {
                   fontFamily: {
                       sans: ['Inter', 'system-ui', 'sans-serif'],
                       mono: ['Source Code Pro', 'Fira Code', 'Consolas', 'monospace'],
                   },
                   colors: {
                       // Nord Palette
                       'bg-primary': '#2E3440',  // Deep Nord Blue (Main Background)
                       'bg-secondary': '#3B4252',// Medium Nord Gray (Card Background)
                       'bg-tertiary': '#ECEFF4', // Snowstorm White (Input/Code Background - light)
                       'text-primary': '#D8DEE9', // Light Nord Text
                       'text-secondary': '#A3BE8C', // Muted Green/Muted Text
                       'text-dark': '#2E3440', // Dark text for light inputs
                       
                       'accent-cyan': '#88C0D0', // Bright Cyan (Focus/Highlight)
                       'accent-red': '#BF616A',  // Salmon/Red (Error/Execute)
                       'border-subtle': '#4C566A', // Muted Blue-Gray Border
                       
                       // Diff Colors based on Nord
                       'diff-removed': 'rgba(191, 97, 106, 0.3)', // Soft Red Diff
                       'diff-added': 'rgba(163, 190, 140, 0.3)', // Soft Green Diff
                       'diff-text-removed': '#BF616A',
                       'diff-text-added': '#A3BE8C',
                   },
                   boxShadow: {
                       'xl-dark': '0 20px 25px -5px rgba(0, 0, 0, 0.4), 0 8px 10px -6px rgba(0, 0, 0, 0.5)',
                       'inner-light': 'inset 0 1px 3px 0 rgba(0, 0, 0, 0.2)',
                   }
               }
           }
       }
   </script>
   <style>
       /* V10.7 Custom styles for the Nord theme */
       body {
           --body-bg: #2E3440;
           --text-dark: #2E3440;
           --text-light: #D8DEE9;
           --accent-cyan: #88C0D0;
           --accent-red: #BF616A;
           background-color: var(--body-bg);
           color: var(--text-light);
           transition: background-color 0.3s;
       }
       
       /* Main application card style */
       .app-card {
           background-color: #3B4252;
           border: 1px solid #4C566A;
           box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
           transition: all 0.3s ease;
       }

       /* Enhanced Code/Input Area Wrapper */
       .code-area-wrapper {
           background-color: #3B4252;
           border: 1px solid #4C566A;
           border-radius: 0.5rem;
           color: var(--text-light);
           font-family: var(--font-mono);
           font-size: 0.875rem;
           line-height: 1.5;
           transition: border-color 0.2s, box-shadow 0.2s;
       }
       
       /* Specific style for editable textareas (Source Code and Rules) - LIGHT BACKGROUND */
       .input-textarea, #sourceCode {
           background-color: #ECEFF4; /* Snowstorm White/Light Gray */
           color: var(--text-dark); /* Dark text for contrast */
           border: 1px solid #D8DEE9;
           border-radius: 0.5rem;
           font-family: var(--font-mono);
           font-size: 0.875rem;
           line-height: 1.5;
           box-shadow: inset 0 1px 3px 0 rgba(0, 0, 0, 0.2);
           transition: border-color 0.2s, box-shadow 0.2s;
       }

       /* Focus state for inputs/textareas */
       .input-textarea:focus, #sourceCode:focus {
           outline: none;
           border-color: var(--accent-cyan);
           box-shadow: 0 0 0 3px rgba(136, 192, 208, 0.4), inset 0 1px 3px 0 rgba(0, 0, 0, 0.2);
       }

       /* Line numbers style */
       .line-numbers {
           color: #4C566A; /* Muted Nord Gray */
           background-color: #3B4252;
           padding: 1rem 0.75rem 1rem 0.5rem;
           text-align: right;
           border-right: 1px solid #4C566A;
           user-select: none;
           flex-shrink: 0;
       }

       /* Diff View Styles */
       .diff-removed {
           color: var(--accent-red);
           background-color: rgba(191, 97, 106, 0.3);
           text-decoration: none;
           padding: 0 3px;
           border-radius: 4px;
           font-weight: 500;
       }
       .diff-added {
           color: #A3BE8C;
           background-color: rgba(163, 190, 140, 0.3);
           padding: 0 3px;
           border-radius: 4px;
           font-weight: 500;
       }
       
       /* Current Match Highlight */
       .current-match {
           border: 1px solid var(--accent-cyan) !important;
           box-shadow: 0 0 5px var(--accent-cyan) !important;
           transition: all 0.2s;
       }

       /* Mode Toggle Styles */
       .mode-button {
           padding: 0.6rem 1.25rem;
           border-radius: 0.6rem;
           font-weight: 600;
           transition: all 0.2s;
           border: 1px solid #4C566A;
       }
       .mode-button.active {
           background-color: var(--accent-cyan);
           color: var(--text-dark);
           border-color: var(--accent-cyan);
           box-shadow: 0 4px 10px rgba(136, 192, 208, 0.4);
       }
       .mode-button:not(.active) {
           background-color: transparent;
           color: var(--text-light);
       }
       .mode-button:not(.active):hover {
           background-color: rgba(255, 255, 255, 0.05);
           color: var(--text-light);
       }
       
       /* Main Execute Button Style */
       #replaceButton {
           background-image: linear-gradient(to right, #BF616A 0%, #D08770 100%); /* Nord Red/Orange Gradient */
           color: var(--text-dark); /* Dark contrast text */
           transition: all 0.2s ease-in-out;
           border: 1px solid #BF616A;
           font-weight: 800;
       }
       #replaceButton:hover {
           opacity: 0.95;
           transform: scale(1.01);
           box-shadow: 0 8px 20px rgba(191, 97, 106, 0.5);
       }
       #replaceButton:disabled {
           background-image: none;
           background-color: #4C566A;
           color: #A3BE8C;
           border-color: #4C566A;
           box-shadow: none;
           cursor: not-allowed;
           transform: scale(1);
       }
       
       /* Modal Ad Container Style for clarity */
       .modal-ad-container {
            min-height: 250px;
            max-height: 400px;
            overflow: hidden;
       }
       
   </style>
</head>
<body class="p-4 sm:p-8 flex flex-col justify-center items-center min-h-screen">
   
   <!-- Firebase SDKs -->
   <script type="module">
       import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
       import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
       import { getFirestore, doc, onSnapshot, setDoc, updateDoc, Timestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
       
       // --- Configuration Constants ---
       const DEFAULT_QUOTA = 10;
       const AD_QUOTA_BONUS = 5;
       
       // --- Global Firebase Instances ---
       window.firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
       window.app = initializeApp(window.firebaseConfig);
       window.db = getFirestore(window.app);
       window.auth = getAuth(window.app);
       window.appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

       // Global Quota State
       window.quota = {
           replacements_left: 0,
           userId: null,
           isLoaded: false
       };

       // --- Core Firebase Initialization and Auth ---
       async function initFirebaseAndAuth() {
           try {
               if (typeof __initial_auth_token !== 'undefined') {
                   await signInWithCustomToken(window.auth, __initial_auth_token);
               } else {
                   await signInAnonymously(window.auth);
               }
               
               // Once authenticated, setup the quota listener
               onAuthStateChanged(window.auth, (user) => {
                   if (user) {
                       window.quota.userId = user.uid;
                       setupQuotaListener();
                       console.log("Firebase Auth Ready. User ID:", user.uid);
                       // Displaying partial ID for security/brevity, though full ID is used for auth
                       document.getElementById('userIdDisplay').textContent = user.uid.substring(0, 8) + '...';
                   } else {
                       console.error("Firebase Auth failed or user logged out.");
                       window.quota.userId = null;
                       window.quota.isLoaded = true;
                       updateQuotaUI();
                   }
               });

           } catch (error) {
               console.error("Firebase Auth or Init Error:", error);
               window.quota.isLoaded = true;
               updateQuotaUI();
           }
       }
       
       // --- Firestore Quota Management ---

       /** Checks if an hourly reset is needed. */
       function isHourlyResetNeeded(lastResetTimestamp) {
           if (!lastResetTimestamp) return true; // If no timestamp, always reset

           const lastResetDate = lastResetTimestamp.toDate();
           const now = new Date();
           
           // Check if the current hour is different from the last reset hour
           const isDifferentHour = now.getHours() !== lastResetDate.getHours();

           // Also ensure reset if the date is different (e.g., crossing midnight)
           const isDifferentDay = now.toDateString() !== lastResetDate.toDateString();

           return isDifferentHour || isDifferentDay;
       }
       
       /** Resets quota to the default amount (10) and updates the timestamp. */
       async function resetQuotaHourly(docRef) {
            try {
               // Perform update with retries
               let attempt = 0;
               const maxRetries = 3;
               while (attempt < maxRetries) {
                   try {
                       await updateDoc(docRef, {
                           replacements_left: DEFAULT_QUOTA,
                           last_reset: new Date()
                       });
                       break; // Success
                   } catch (e) {
                       attempt++;
                       if (attempt >= maxRetries) throw e;
                       await new Promise(resolve => setTimeout(resolve, Math.pow(2, attempt) * 100));
                   }
               }
            } catch (e) {
                console.error("Error resetting quota document:", e);
            }
       }


       /** Sets up real-time listener for user's quota status. */
       function setupQuotaListener() {
           if (!window.quota.userId) return;

           // Firestore Path: /artifacts/{appId}/users/{userId}/quota_status/status
           const quotaDocRef = doc(
               window.db,
               `artifacts/${window.appId}/users/${window.quota.userId}/quota_status/status`
           );

           onSnapshot(quotaDocRef, (docSnapshot) => {
               if (docSnapshot.exists()) {
                   const data = docSnapshot.data();
                   
                   // --- Hourly Reset Logic ---
                   if (isHourlyResetNeeded(data.last_reset)) {
                       resetQuotaHourly(quotaDocRef);
                       window.quota.replacements_left = DEFAULT_QUOTA;
                       showStatus(`‚è∞ ÈÖçÈ°çÂ∑≤ÈáçË®≠Âà∞ ${DEFAULT_QUOTA} Ê¨° (Êï¥ÈªûÊõ¥Êñ∞)„ÄÇ`, 'info');

                   } else {
                       window.quota.replacements_left = data.replacements_left || 0;
                       console.log("Quota loaded from Firestore:", window.quota.replacements_left);
                   }
                   
               } else {
                   // Initialize document if it doesn't exist (new user)
                   window.quota.replacements_left = DEFAULT_QUOTA;
                   initializeQuotaDocument(quotaDocRef);
                   console.log(`Quota document initialized to ${DEFAULT_QUOTA}.`);
               }
               window.quota.isLoaded = true;
               updateQuotaUI();
           }, (error) => {
               console.error("Error listening to quota status:", error);
               window.quota.replacements_left = 0;
               window.quota.isLoaded = true;
               updateQuotaUI();
           });
       }
       
       /** Initializes the quota document for new users. */
       async function initializeQuotaDocument(docRef) {
            try {
               await setDoc(docRef, {
                   replacements_left: DEFAULT_QUOTA, // Set initial to 10
                   last_reset: new Date(),
                   user_id: window.quota.userId
               });
            } catch (e) {
                console.error("Error initializing quota document:", e);
            }
       }

       /** Decrements quota after a successful replacement. */
       window.decrementQuota = async function() {
           if (window.quota.replacements_left <= 0) return;

           const newQuota = window.quota.replacements_left - 1;
           const quotaDocRef = doc(
               window.db,
               `artifacts/${window.appId}/users/${window.quota.userId}/quota_status/status`
           );

           try {
               let attempt = 0;
               const maxRetries = 3;
               while (attempt < maxRetries) {
                   try {
                       await updateDoc(quotaDocRef, {
                           replacements_left: newQuota
                       });
                       break; // Success
                   } catch (e) {
                       attempt++;
                       if (attempt >= maxRetries) throw e;
                       await new Promise(resolve => setTimeout(resolve, Math.pow(2, attempt) * 100));
                   }
               }
               
               showStatus(`‚úÖ Âèñ‰ª£ÊàêÂäüÔºÅÂâ©È§òÊ¨°Êï∏: ${newQuota}`, 'success');
           } catch (e) {
               console.error("Error decrementing quota:", e);
               showStatus('‚ö†Ô∏è Ë≠¶Âëä: Ê∏õÂ∞ëÈÖçÈ°çÊôÇÁôºÁîüÈåØË™§ (Quota decrement failed).', 'error');
           }
       }
       
       /** Grants 5 extra replacements. */
       window.grantQuota = async function() {
           if (!window.quota.userId) {
               showStatus('üö´ ÈåØË™§: ‰ΩøÁî®ËÄÖÊú™ÁôªÂÖ•ÔºåÁÑ°Ê≥ïÂ¢ûÂä†ÈÖçÈ°ç (User not authenticated).', 'error');
               return;
           }
           
           if (!window.quota.isLoaded) {
               showStatus('‚è≥ Ë≠¶Âëä: Ë≥áÊñôÂ∫´Â∞öÊú™ËºâÂÖ•ÂÆåÊàêÔºåË´ãÁ®çÂÄôÂÜçË©¶ (Database not ready).', 'info');
               return;
           }

           const newQuota = window.quota.replacements_left + AD_QUOTA_BONUS; // Add 5
           const quotaDocRef = doc(
               window.db,
               `artifacts/${window.appId}/users/${window.quota.userId}/quota_status/status`
           );

           try {
               let attempt = 0;
               const maxRetries = 3;
               while (attempt < maxRetries) {
                   try {
                       await updateDoc(quotaDocRef, {
                           replacements_left: newQuota
                       });
                       break; // Success
                   } catch (e) {
                       attempt++;
                       if (attempt >= maxRetries) throw e;
                       await new Promise(resolve => setTimeout(resolve, Math.pow(2, attempt) * 100));
                   }
               }
               
               showStatus(`üéâ ÊàêÂäü! Â∑≤Êñ∞Â¢û ${AD_QUOTA_BONUS} Ê¨°ÈÖçÈ°ç„ÄÇÁõÆÂâçÂâ©È§òÊ¨°Êï∏: ${newQuota}`, 'success');
           } catch (e) {
               console.error("Error granting quota:", e);
               showStatus('‚ö†Ô∏è Ë≠¶Âëä: Â¢ûÂä†ÈÖçÈ°çÊôÇÁôºÁîüÈåØË™§ (Quota grant failed).', 'error');
           }
       }
       
       // Start Firebase process
       window.addEventListener('load', initFirebaseAndAuth);

       // Export functions to global scope for use in HTML event handlers
       window.updateQuotaUI = updateQuotaUI;
   </script>

   <!-- Âª£Âëä‰ΩçÊèêÁ§∫: Á∏ΩÂÖ± 7 ÂÄãÂª£Âëä‰Ωç (4 ÂÖßÂµå + 2 ÂΩàÁ™ó/ÊèíÈ†Å + 1 ÂÖßÂµå‰ΩÜÂèØ‰ΩúÁÇ∫ÊèíÈ†Å) -->
   
   <!-- 1. Ê©´ÂπÖÂª£Âëä (Banner Ad): È†ÇÈÉ®Ê©´ÂπÖ (Ad Slot 1/7) - Â∑≤ÂØ¶‰ΩúÊôÆÈÄöÂª£ÂëäËÖ≥Êú¨ 1/3 -->
   <div id="ad-slot-1" class="ad-slot-container w-full max-w-4xl mx-auto mb-6 flex justify-center h-auto min-h-[50px] items-center border border-border-subtle rounded-lg bg-bg-secondary p-2">
       <!-- ÂØ¶‰ΩúÁî®Êà∂Êèê‰æõÁöÑÊôÆÈÄöÂª£ÂëäËÖ≥Êú¨ 1 -->
       <script>
       (function(mtx){
       var d = document,
           s = d.createElement('script'),
           l = d.scripts[d.scripts.length - 1];
       s.settings = mtx || {};
       s.src = "\/\/wirytrip.com\/bcXIV.sqd\/GHlA0CYmW\/co\/WeimR9Cu\/ZOUelMkaPdTbYZ3zMhj\/QPz\/N\/jJEwtAN\/j\/cVy\/NqDlMI2TMzgN";
       s.async = true;
       s.referrerPolicy = 'no-referrer-when-downgrade';
       l.parentNode.insertBefore(s, l);
       })({})
       </script>
   </div>

   <!-- ‰∏≠Â§ÆÊáâÁî®Á®ãÂºèÂÆπÂô® (ÂñÆ‰∏ÄÂûÇÁõ¥Â†ÜÁñä) -->
   <div class="w-full max-w-4xl mx-auto space-y-8" id="main-content">
       
       <!-- Ê®ôÈ°åÂçÄ (V10.7: Header) -->
       <header class="text-center pb-4 pt-0 lg:pt-4">
           <h1 class="text-4xl sm:text-5xl md:text-6xl font-extrabold text-accent-cyan tracking-tight hover:scale-[1.01] transition-transform duration-300">
               CODE REPLACER <span class="text-accent-red">PRO</span>
           </h1>
           <p class="text-sm sm:text-base text-text-secondary mt-2 font-mono">
               ü§ñ Ë∫´‰ªΩ ID (ÈÉ®ÂàÜ): <span id="userIdDisplay" class="text-text-primary text-xs">...ËºâÂÖ•‰∏≠...</span>
           </p>
       </header>
       
       <!-- 1. ÂéüÂßãÁ¢ºËàáÂ∑ÆÁï∞Ê™¢Ë¶ñÂçÄ (Section 1: ‰∏ªË¶ÅÂ∑•‰ΩúÂçÄ) -->
       <div class="app-card p-6 md:p-8 rounded-xl">
           <h2 class="text-xl font-bold text-text-primary mb-4 border-b border-border-subtle pb-2 flex items-center">
               <svg class="w-5 h-5 mr-2 text-accent-cyan" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"></path></svg>
               1. Á®ãÂºèÁ¢ºÂ∑•‰ΩúÂçÄ (Code Workspace)
           </h2>

           <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 lg:gap-8">
               
               <!-- A. ÂéüÂßãÁ¢ºËº∏ÂÖ• (Â∑¶ÂÅ¥/È†ÇÈÉ®) -->
               <div>
                   <label for="sourceCode" class="block text-sm font-semibold text-text-primary mb-2">ÂéüÂßãÁ¢º (Source Code)
                       <span id="selectionHint" class="text-xs text-accent-cyan ml-2 italic"></span>
                   </label>
                   <textarea id="sourceCode" class="w-full p-4 input-textarea min-h-[300px] shadow-inner-light" placeholder="Ë´ãÂ∞áÊÇ®ÁöÑÂÆåÊï¥Á®ãÂºèÁ¢ºË≤ºÂú®Ê≠§Ëôï..." oninput="saveState(); handleInputChange();" onscroll="syncScroll('sourceCode', 'lineNumbersContainer')" onmouseup="updateSelectionRange()"></textarea>
               </div>

               <!-- B. Â∑ÆÁï∞Ê™¢Ë¶ñÁµêÊûú (Âè≥ÂÅ¥/‰∏ãÊñπ) -->
               <div>
                   <label class="block text-sm font-semibold text-text-primary mb-2">Â∑ÆÁï∞Ê™¢Ë¶ñÈ†êË¶Ω (DIFF VIEW PREVIEW)</label>
                   <div id="lineNumbersContainer" class="code-area-wrapper shadow-xl-dark flex min-h-[300px] overflow-y-auto" onscroll="syncScroll('lineNumbersContainer', 'sourceCode')">
                       <div id="lineNumbers" class="line-numbers sticky top-0"></div>
                       <div id="previewCode" class="p-4 flex-grow text-text-primary text-sm whitespace-pre-wrap break-words">
                           <span class="text-text-secondary">Ë´ãËº∏ÂÖ•Á®ãÂºèÁ¢º‰ª•ÈñãÂßãÂÅµÊ∏¨...</span>
                       </div>
                   </div>
               </div>

           </div>
       </div>
       
       <!-- 2. Áü©ÂΩ¢Âª£Âëä (Ad Slot 2/7 - 300x250 Áü©ÂΩ¢Âª£Âëä 1) - Â∑≤ÂØ¶‰ΩúÊôÆÈÄöÂª£ÂëäËÖ≥Êú¨ 3/3 -->
       <div class="flex justify-center w-full">
           <div id="ad-slot-2" class="ad-slot-container w-[300px] h-[250px] flex items-center justify-center border-2 border-dashed border-border-subtle rounded-xl text-sm text-text-secondary p-4 bg-bg-secondary shadow-xl-dark">
               <!-- ÂØ¶‰ΩúÁî®Êà∂Êèê‰æõÁöÑÊôÆÈÄöÂª£ÂëäËÖ≥Êú¨ 3 -->
               <script>
               (function(cekj){
               var d = document,
                   s = d.createElement('script'),
                   l = d.scripts[d.scripts.length - 1];
               s.settings = cekj || {};
               s.src = "\/\/wirytrip.com\/bCXhV.sOd\/Gql-0fYUWycQ\/tebmp9xuDZ\/UslnkCPXT\/YY3uM\/jsQ-zCNVzYMQt\/N\/j\/cHyuNNDgMH3TNkAe";
               s.async = true;
               s.referrerPolicy = 'no-referrer-when-downgrade';
               l.parentNode.insertBefore(s, l);
               })({})
               </script>
           </div>
       </div>

       <!-- 3. Âèñ‰ª£Ë¶èÂâáË®≠ÂÆöÂçÄ (Section 2: Ê®°ÂºèÂàáÊèõËàáË¶èÂâáÈÖçÁΩÆ) -->
       <div class="app-card p-6 md:p-8 rounded-xl">
           
           <!-- Ê®ôÈ°åËàáÈÖçÈ°çÈ°ØÁ§∫ + Âª£ÂëäÊåâÈàï (V10.7: Integrated Quota & Ad Button) -->
           <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 border-b border-border-subtle pb-3">
               <h2 class="text-xl font-bold text-text-primary flex items-center">
                   <svg class="w-5 h-5 mr-2 text-accent-red" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                   3. Âèñ‰ª£Ë¶èÂâáÈÖçÁΩÆ (Rule Configuration)
               </h2>
               
               <!-- Quota Display and Ad Button Group -->
               <div class="flex items-center space-x-3 mt-3 sm:mt-0">
                   <!-- Quota Display -->
                   <div id="quotaDisplaySmallBox" class="flex items-center space-x-3 p-3 rounded-lg bg-bg-secondary border border-border-subtle text-sm font-bold shadow-md">
                       <span class="text-text-secondary">ÈÖçÈ°çÂâ©È§ò:</span>
                       <!-- Quota Count -->
                       <span id="quotaDisplay" class="text-text-primary">ËºâÂÖ•‰∏≠...</span>
                   </div>
                   
                   <!-- ÁçéÂãµÂºèÂª£ÂëäÊåâÈàï (Ad Slot 5/7 - ÂΩàÁ™óÂª£Âëä 1/2: Â∑≤ÂØ¶‰ΩúËÖ≥Êú¨ËºâÂÖ•) -->
                   <button id="grantQuotaAdButton" class="text-sm font-bold text-bg-primary bg-accent-cyan rounded-lg p-2 hover:bg-accent-cyan/80 transition duration-150 shadow-md shadow-accent-cyan/50 flex items-center" onclick="handleRewardAdClick()">
                       <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.803v4.394a1 1 0 001.555.832l3.197-2.132c.563-.376.563-1.168 0-1.544z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                       +5 ÈÖçÈ°ç 
                   </button>
               </div>
           </div>
           
           <!-- Ê®°ÂºèÂàáÊèõËàáË¶èÂâáÈÖçÁΩÆ Grid -->
           <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 lg:gap-8">
               
               <!-- A. Ê®°ÂºèÂàáÊèõËàáÊéßÂà∂ (Column 1) -->
               <div class="lg:col-span-1 flex flex-col space-y-4">
                   <label class="block text-sm font-semibold text-text-primary">ÈÅ∏ÊìáÊ®°Âºè (Select Mode)</label>
                   <div class="flex space-x-4">
                       <button id="simpleModeBtn" class="mode-button active flex-1" onclick="setMode('simple')">‚ú® Á∞°ÂñÆÊ®°Âºè</button>
                       <button id="pipelineModeBtn" class="mode-button flex-1" onclick="setMode('pipeline')">‚öôÔ∏è ÁÆ°Á∑öÊ®°Âºè</button>
                   </div>
                   
                   <div class="pt-2">
                       <label class="block text-sm font-semibold text-text-primary mb-2">‰∏ä‰∏ãÊñáÈôêÂÆö (Scope Control)</label>
                       
                       <div id="scopeControl" class="p-4 bg-bg-secondary rounded-lg border border-border-subtle shadow-inner-light">
                           <div class="flex items-center space-x-3 text-sm text-text-primary">
                               <label class="relative inline-flex items-center cursor-pointer toggle-switch">
                                   <input type="checkbox" id="limitToSelection" class="sr-only peer" role="switch" onchange="saveState(); handleInputChange();">
                                   <div class="w-11 h-6 bg-border-subtle peer-focus:ring-4 peer-focus:ring-accent-cyan rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-accent-cyan"></div>
                               </label>
                               <span class="font-medium">ÂÉÖ‰ΩúÁî®ÊñºÈÅ∏ÂÆöÁØÑÂúç</span>
                           </div>
                           <p id="selectionRangeInfo" class="text-xs text-text-secondary mt-2 italic">Êú™ÈÅ∏ÂÆöÁØÑÂúç.</p>
                       </div>
                   </div>

                   <!-- Âü∑Ë°åÊåâÈàï (High Contrast) -->
                   <button id="replaceButton" onclick="" class="w-full py-4 mt-6 font-extrabold rounded-xl shadow-xl hover:scale-[1.03]" disabled>
                       ‚ö° Âü∑Ë°åÂèñ‰ª£ (RUN REPLACEMENT) ‚ö°
                   </button>
               </div>

               <!-- C. Ë¶èÂâáËº∏ÂÖ•ÂçÄ (Column 2 & 3) -->
               <div id="ruleInputContainer" class="lg:col-span-2 space-y-4">
                   
                   <!-- B.1 Á∞°ÂñÆÊ®°ÂºèÂÖßÂÆπ -->
                   <div id="simpleModeInputs" class="space-y-4">
                       <div>
                           <label for="findSimple" class="block text-sm font-semibold text-text-primary mb-2">Â∞ãÊâæÂçÄÂ°ä (Find Block)</label>
                           <textarea id="findSimple" class="w-full resize-y p-3 input-textarea min-h-[75px] shadow-inner-light" oninput="saveState(); handleInputChange();" placeholder='‰æãÂ¶Ç: console.log("debug");'></textarea>
                       </div>
                       <div>
                           <label for="replaceSimple" class="block text-sm font-semibold text-text-primary mb-2">Âèñ‰ª£ÂÖßÂÆπ (Replacement Content)</label>
                           <textarea id="replaceSimple" class="w-full resize-y p-3 input-textarea min-h-[75px] shadow-inner-light" oninput="saveState(); handleInputChange();" placeholder='‰æãÂ¶Ç: logger.info("log");'></textarea>
                       </div>
                       <div class="flex items-center space-x-6 pt-2">
                           <label class="text-sm font-medium text-text-primary flex items-center cursor-pointer">
                               <input type="checkbox" id="regexSimple" class="w-4 h-4 text-accent-cyan bg-bg-secondary border-border-subtle rounded focus:ring-accent-cyan mr-2" onchange="saveState(); handleInputChange();">
                               ‰ΩøÁî®Ê≠£Ë¶èË°®ÈÅîÂºè (Regex)
                           </label>
                           <label class="text-sm font-medium text-text-primary flex items-center cursor-pointer">
                               <input type="checkbox" id="caseSensitiveSimple" class="w-4 h-4 text-accent-cyan bg-bg-secondary border-border-subtle rounded focus:ring-accent-cyan mr-2" checked onchange="saveState(); handleInputChange();">
                               ÂçÄÂàÜÂ§ßÂ∞èÂØ´ (Case Sensitive)
                           </label>
                       </div>
                   </div>

                   <!-- B.2 ÁÆ°Á∑öÊ®°ÂºèÂÖßÂÆπ -->
                   <div id="pipelineModeInputs" class="hidden">
                        <label for="rulesJson" class="block text-sm font-semibold text-text-primary mb-2">Â§öÈáçÂèñ‰ª£Ë¶èÂâá (JSON Ê†ºÂºè)
                           <span class="text-xs text-accent-red ml-2 italic" id="jsonErrorHint"></span>
                       </label>
                       <textarea id="rulesJson" class="w-full resize-y p-3 input-textarea min-h-[250px] shadow-inner-light" oninput="saveState(); handleInputChange();" placeholder='[
{
   "find": "old_var_name",
   "replace": "new_var_name",
   "regex": false,
   "caseSensitive": true
},
// ... more rules
]'></textarea>
                   </div>
               </div>
           </div>
       </div>
       
       <!-- 4. Áü©ÂΩ¢Âª£Âëä (Ad Slot 3/7 - 300x250 Áü©ÂΩ¢Âª£Âëä 2) - Â∑≤ÂØ¶‰ΩúÁî®Êà∂Êèê‰æõÁöÑÂΩ±ÁâáÂª£ÂëäËÖ≥Êú¨ 4/4 -->
       <div class="flex justify-center w-full">
           <div id="ad-slot-3" class="ad-slot-container w-[300px] h-[250px] flex items-center justify-center border-2 border-dashed border-border-subtle rounded-xl text-sm text-text-secondary p-4 bg-bg-secondary shadow-xl-dark">
               <!-- ÂØ¶‰ΩúÁî®Êà∂Êèê‰æõÁöÑÂΩ±ÁâáÂª£ÂëäËÖ≥Êú¨ 4 -->
               <script>
               (function(jlq){
               var d = document,
                   s = d.createElement('script'),
                   l = d.scripts[d.scripts.length - 1];
               s.settings = jlq || {};
               s.src = "\/\/wirytrip.com\/bcXRV.sjdaGYlZ0UYlWmcU\/neQmU9Cu\/ZMUXl-k\/PoTmYw3BMVjEQkzoNmz-cctzNxj_cUyfNVDkMe3\/OWAh";
               s.async = true;
               s.referrerPolicy = 'no-referrer-when-downgrade';
               l.parentNode.insertBefore(s, l);
               })({})
               </script>
           </div>
       </div>

       <!-- 5. Ê≠∑Âè≤Á¥ÄÈåÑËàáËø≠‰ª£ÊéßÂà∂ÂçÄ (Section 3) -->
       <div class="app-card p-6 md:p-8 rounded-xl">
           <h2 class="text-xl font-bold text-text-primary mb-4 border-b border-border-subtle pb-2 flex items-center">
               <svg class="w-5 h-5 mr-2 text-text-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
               5. Ê≠∑Âè≤Á¥ÄÈåÑËàáÂñÆÊ≠•ÊéßÂà∂ (History & Step Control)
           </h2 >
           
           <div class="flex flex-col sm:flex-row justify-between items-center gap-4">
               
               <!-- Ê≠∑Âè≤Á¥ÄÈåÑ (UNDO/REDO/DOWNLOAD) -->
               <div class="flex flex-wrap gap-3 w-full sm:w-auto">
                   <button id="undoButton" onclick="undo()" class="flex-1 sm:flex-none py-2 px-4 bg-bg-secondary text-text-primary rounded-lg border border-border-subtle hover:bg-bg-secondary/80 focus:ring-2 focus:ring-accent-cyan disabled:opacity-50 transition duration-150 text-sm font-medium shadow-md">
                       ‚Ü© Êí§Èä∑ (Undo)
                   </button>
                   <button id="redoButton" onclick="redo()" class="flex-1 sm:flex-none py-2 px-4 bg-bg-secondary text-text-primary rounded-lg border border-border-subtle hover:bg-bg-secondary/80 focus:ring-2 focus:ring-accent-cyan disabled:opacity-50 transition duration-150 text-sm font-medium shadow-md">
                       ‚Ü™ ÈáçÂÅö (Redo)
                   </button>
                   <!-- ‰∏ãËºâÊåâÈàï (Ad Slot 7/7 - ÂΩàÁ™óÂª£Âëä 2/2) -->
                   <button id="downloadButton" onclick="downloadCode()" class="flex-1 sm:flex-none py-2 px-4 bg-accent-cyan text-text-dark font-bold rounded-lg hover:bg-accent-cyan/80 focus:ring-2 focus:ring-accent-cyan/50 transition duration-150 text-sm font-medium shadow-lg">
                       ‚¨á ‰∏ãËºâ (Download)
                   </button>
               </div>

               <!-- Ëø≠‰ª£ÊéßÂà∂ (FIND NEXT/REPLACE NEXT) -->
               <div class="flex flex-wrap gap-3 w-full sm:w-auto justify-end">
                   <button id="findNextButton" onclick="findNext()" class="flex-1 sm:flex-none py-2 px-4 bg-bg-secondary text-accent-cyan rounded-lg border border-accent-cyan/50 hover:bg-bg-secondary/80 focus:ring-2 focus:ring-accent-cyan disabled:opacity-50 transition duration-150 text-sm font-medium shadow-md">
                       Â∞ãÊâæ‰∏ã‰∏ÄÂÄã
                   </button>
                   <button id="replaceNextButton" onclick="replaceNext()" class="flex-1 sm:flex-none py-2 px-4 bg-bg-secondary text-accent-red rounded-lg border border-accent-red/50 hover:bg-bg-secondary/80 focus:ring-2 focus:ring-accent-red disabled:opacity-50 transition duration-150 text-sm font-medium shadow-md">
                       Âèñ‰ª£‰∏ã‰∏ÄÂÄã
                   </button>
               </div>

           </div>
       </div>

   </div> <!-- end of Central Layout container -->

   <!-- ÁãÄÊÖãË®äÊÅØ -->
   <div id="statusMessage" class="mt-8 text-center p-4 rounded-lg font-medium text-sm transition-all duration-300 border border-transparent w-full max-w-4xl" role="status" aria-live="polite">
       <span class="text-text-secondary">üí° INIT: Ê≠°Ëøé‰ΩøÁî®Á®ãÂºèÁ¢ºÂèñ‰ª£Â∑•ÂÖ∑ (V10.7). Ê≠£Âú®ÈÄ£Êé•Ë≥áÊñôÂ∫´...</span>
   </div>

   <!-- Modal (Handles Confirmation ONLY) -->
   <div id="appModal" class="hidden fixed inset-0 bg-bg-primary bg-opacity-95 flex items-center justify-center p-4 z-50 transition-opacity duration-300">
       <div class="bg-bg-secondary rounded-xl p-6 md:p-8 shadow-2xl border border-accent-red/50 max-w-sm md:max-w-md w-full transform hover:scale-[1.01] transition-transform">
           <h3 class="text-2xl font-bold mb-4 text-accent-red border-b border-border-subtle pb-2"></h3>
           <p class="mb-6 text-text-primary text-base"></p>

           <!-- Âª£ÂëäÂÖßÂÆπ‰Ωî‰ΩçÁ¨¶ (Â∑≤ÁßªÈô§ÔºåÊ≠§ Modal ÁèæÂÉÖÁî®ÊñºÂèñ‰ª£Á¢∫Ë™ç) -->
           <div id="modalAdContainer" class="hidden"></div>

           <div class="flex justify-end space-x-3">
               <!-- Used for Replacement Confirmation: Cancel -->
               <button id="modalCancel" class="py-2 px-4 border border-border-subtle rounded-lg text-text-secondary hover:bg-bg-secondary/80 transition duration-150 font-medium text-sm">
                   ÂèñÊ∂à (ABORT)
               </button>
               <!-- Used for Replacement Confirmation: Confirm -->
               <button id="modalConfirm" class="py-2 px-4 bg-accent-red text-text-dark font-bold rounded-lg hover:bg-accent-red/80 transition duration-150 text-sm shadow-md shadow-accent-red/50">
                   Á¢∫ÂÆöÂü∑Ë°å (CONFIRM)
               </button>
               <!-- Used for Ad Close: Close Ad (Â∑≤ÁßªÈô§ÔºåÂõ† Ad Slot 7/7 ÁèæÁÇ∫ËÖ≥Êú¨Ëß∏Áôº) -->
               <button id="modalCloseAd" class="hidden"></button>
           </div>
       </div>
   </div>
   
   <!-- 6. Ê©´ÂπÖÂª£Âëä (Banner Ad): Â∫ïÈÉ®Ê©´ÂπÖ (Ad Slot 4/7) - Â∑≤ÂØ¶‰ΩúÊôÆÈÄöÂª£ÂëäËÖ≥Êú¨ 2/3 -->
   <div id="ad-slot-6" class="ad-slot-container w-full max-w-4xl mx-auto mt-6 mb-4 flex justify-center h-auto min-h-[50px] items-center border border-border-subtle rounded-lg bg-bg-secondary p-2">
       <!-- ÂØ¶‰ΩúÁî®Êà∂Êèê‰æõÁöÑÊôÆÈÄöÂª£ÂëäËÖ≥Êú¨ 2 -->
       <script>
       (function(pwqj){
       var d = document,
           s = d.createElement('script'),
           l = d.scripts[d.scripts.length - 1];
       s.settings = pwqj || {};
       s.src = "\/\/wirytrip.com\/bzXzVGsOd.GTl\/0NYIWMcX\/sesmw9\/uZZwUzllkoPwT_Yc3OMRjDQXzrNrj\/cZt-N-jQcmyXN\/DEMr2FORAU";
       s.async = true;
       s.referrerPolicy = 'no-referrer-when-downgrade';
       l.parentNode.insertBefore(s, l);
       })({})
       </script>
   </div>

   <script>
       // DOM Elements
       const sourceCodeEl = document.getElementById('sourceCode');
       const replaceButton = document.getElementById('replaceButton');
       const statusMessageEl = document.getElementById('statusMessage');
       const appModal = document.getElementById('appModal');
       const modalConfirmButton = document.getElementById('modalConfirm');
       const modalCancelButton = document.getElementById('modalCancel');
       const lineNumbersEl = document.getElementById('lineNumbers');
       const lineNumbersContainerEl = document.getElementById('lineNumbersContainer');
       const undoButton = document.getElementById('undoButton');
       const redoButton = document.getElementById('redoButton');
       const findNextButton = document.getElementById('findNextButton');
       const replaceNextButton = document.getElementById('replaceNextButton');
       const selectionRangeInfoEl = document.getElementById('selectionRangeInfo');
       const limitToSelectionEl = document.getElementById('limitToSelection');
       const selectionHintEl = document.getElementById('selectionHint');
       const simpleModeBtn = document.getElementById('simpleModeBtn');
       const pipelineModeBtn = document.getElementById('pipelineModeBtn');
       const simpleModeInputs = document.getElementById('simpleModeInputs');
       const pipelineModeInputs = document.getElementById('pipelineModeInputs');
       const rulesJsonEl = document.getElementById('rulesJson');
       const jsonErrorHintEl = document.getElementById('jsonErrorHint');
       const findSimpleEl = document.getElementById('findSimple');
       const replaceSimpleEl = document.getElementById('replaceSimple');
       const regexSimpleEl = document.getElementById('regexSimple');
       const caseSensitiveSimpleEl = document.getElementById('caseSensitiveSimple');
       const previewCodeEl = document.getElementById('previewCode');
       const quotaDisplayEl = document.getElementById('quotaDisplay');
       const grantQuotaAdButton = document.getElementById('grantQuotaAdButton');
       
       // --- Global State Variables ---
       let isSimpleMode = true;
       window.parsedRules = [];
       let allMatches = [];
       let currentMatchIndex = 0;
       let matchFound = false;
       let selectionRange = { start: 0, end: 0 };
       
       let history = [];
       let historyIndex = -1;

       // --- Core UI Updates ---

       /** V10.7: Updates the Quota UI and button state */
       function updateQuotaUI() {
           const quota = window.quota.replacements_left;
           const isLoaded = window.quota.isLoaded;
           
           if (isLoaded) {
               quotaDisplayEl.innerHTML = `<span class="${quota > 0 ? 'text-accent-cyan' : 'text-accent-red'}">${quota}</span> Ê¨°`;
               
               const rulesParsed = window.parsedRules && window.parsedRules.length > 0;
               replaceButton.disabled = quota <= 0 || !rulesParsed;
               
               if (quota <= 0 && rulesParsed) {
                   showStatus('üö´ ÈÖçÈ°çÁî®Áõ°! Ë´ãÁ≠âÂæÖÊ¨°Êó•ÈáçË®≠ÔºåÊàñÈªûÊìäÂΩàÁ™óÂª£ÂëäÊåâÈàïÁç≤ÂèñÊõ¥Â§öÊ¨°Êï∏„ÄÇ', 'error');
               }
               
           } else {
                quotaDisplayEl.textContent = `ËºâÂÖ•‰∏≠...`;
                replaceButton.disabled = true;
           }
       }
       
       // --- Download Logic ---
       
       /** V10.3: Performs the actual file download. */
       function performDownload() {
           const code = sourceCodeEl.value;
           const blob = new Blob([code], { type: 'text/plain' });
           const url = URL.createObjectURL(blob);
           const a = document.createElement('a');
           a.href = url;
           a.download = 'refactored_code_' + Date.now() + '.txt';
           document.body.appendChild(a);
           a.click();
           document.body.removeChild(a);
           URL.revokeObjectURL(url);
       }

       /** V10.3: Handles the click on the Download button (triggers Pop-up Ad Script 2/2). (Ad Slot 7/7) */
       function downloadCode() {
           if (sourceCodeEl.value.trim().length === 0) {
               showStatus('‚ùå ÈåØË™§: ÂéüÂßãÁ¢ºÁÇ∫Á©∫ÔºåÁÑ°Ê≥ï‰∏ãËºâ (Source code is empty, cannot download).', 'error');
               return;
           }
           
           // --- Âª£Âëä‰Ωç 7/7: ÂΩàÁ™óÂª£ÂëäÂØ¶È´î‰ª£Á¢º (Áî±‰∏ãËºâÊåâÈàïËß∏Áôº) ---
           // ÂãïÊÖãËºâÂÖ•‰∏¶Âü∑Ë°åÊÇ®ÁöÑÁ¨¨‰∫åÂÄãÂ§ñÈÉ®ÂΩàÁ™óËÖ≥Êú¨„ÄÇ
           const scriptEl = document.createElement('script');
           scriptEl.async = true;
           // Á¨¨‰∫åÂÄãÂΩàÁ™óÂª£Âëä URL
           scriptEl.src = 'https://cylindrical-occasion.com/bZ3/Vm0pP.3/p/vjbPmoVbJsZ-D_0y2aNKzZI/0gMaz/kq0/LgT/YC3PMPjNQmzbOpTwUU';
           document.body.appendChild(scriptEl);
           
           // Áî±ÊñºÁÑ°Ê≥ïÂÅµÊ∏¨Â§ñÈÉ®ÂΩàÁ™ó/ÈáçÂÆöÂêëÂª£ÂëäÊòØÂê¶ÂÆåÊàêËßÄÁúãÔºå‰∏ãËºâÂ∞áÂú®ËÖ≥Êú¨Âü∑Ë°åÂæåÁ´ãÂç≥ÈñãÂßã„ÄÇ
           performDownload();
           
           showStatus('‚úÖ ÂΩàÁ™óÂª£Âëä (2/2) Â∑≤ÂòóË©¶ÂïüÂãïÔºåÁ®ãÂºèÁ¢º‰∏ãËºâÂ∑≤ÈñãÂßã...', 'success');
       }

       // --- Core Utilities ---

       /** V9.1: Set the current mode (simple or pipeline) */
       function setMode(mode) {
           isSimpleMode = mode === 'simple';
           
           simpleModeBtn.classList.toggle('active', isSimpleMode);
           pipelineModeBtn.classList.toggle('active', !isSimpleMode);

           simpleModeInputs.classList.toggle('hidden', !isSimpleMode);
           pipelineModeInputs.classList.toggle('hidden', isSimpleMode);

           replaceButton.textContent = isSimpleMode ? '‚ö° Âü∑Ë°åÂèñ‰ª£ (RUN REPLACEMENT) ‚ö°' : '‚ö° Âü∑Ë°åÂèñ‰ª£ÁÆ°Á∑ö (RUN PIPELINE) ‚ö°';

           saveState();
           handleInputChange();
       }

       /** Debounce utility function */
       function debounce(func, timeout = 350) {
           let timer;
           return (...args) => {
               clearTimeout(timer);
               timer = setTimeout(() => {
                   func.apply(this, args);
               }, timeout);
           };
       }

       /** V9.1: Generate single-rule JSON from simple inputs */
       function generateSimpleRule() {
           const find = findSimpleEl.value;
           const replace = replaceSimpleEl.value;
           const regex = regexSimpleEl.checked;
           const caseSensitive = caseSensitiveSimpleEl.checked;

           if (find.trim().length === 0) {
               return [];
           }

           return [{
               find: find,
               replace: replace,
               regex: regex,
               caseSensitive: caseSensitive
           }];
       }

       /** Parse Rules (V9.1: Based on mode) */
       function parseRules() {
           let rules = null;

           if (isSimpleMode) {
               rules = generateSimpleRule();
               jsonErrorHintEl.textContent = '';
           } else {
               try {
                   rules = JSON.parse(rulesJsonEl.value);
                   if (!Array.isArray(rules) || rules.length === 0) {
                       throw new Error("Ë¶èÂâáÂøÖÈ†àÊòØ‰∏ÄÂÄãÈùûÁ©∫ÁöÑÈô£Âàó (Rules must be a non-empty array).");
                   }
                   jsonErrorHintEl.textContent = '‚úÖ JSON Ê†ºÂºèÊ≠£Á¢∫';
                   jsonErrorHintEl.classList.remove('text-accent-red');
                   jsonErrorHintEl.classList.add('text-accent-cyan');
               } catch (e) {
                   window.parsedRules = [];
                   jsonErrorHintEl.textContent = '‚ùå JSON Ê†ºÂºèÈåØË™§: ' + e.message.substring(0, 50) + '...';
                   jsonErrorHintEl.classList.add('text-accent-red');
                   jsonErrorHintEl.classList.remove('text-accent-cyan');
                   return null;
               }
           }

           if (!rules || rules.length === 0) {
                window.parsedRules = [];
                updateQuotaUI();
                return null;
           }

           window.parsedRules = rules;
           updateQuotaUI();
           return rules;
       }

       /** Update history stack and button states */
       function updateHistory(newCode, pushToHistory = true) {
           if (history[historyIndex] === newCode) return;

           if (pushToHistory) {
               if (historyIndex < history.length - 1) {
                   history = history.slice(0, historyIndex + 1);
               }
               
               history.push(newCode);
               historyIndex++;
           }

           const maxHistory = 50;
           if (history.length > maxHistory) {
               history.shift();
               historyIndex--;
           }

           updateHistoryButtons();
       }

       /** Updates the enabled/disabled state of history buttons */
       function updateHistoryButtons() {
           undoButton.disabled = historyIndex <= 0;
           redoButton.disabled = historyIndex >= history.length - 1;
       }

       /** Undo operation */
       function undo() {
           if (historyIndex > 0) {
               historyIndex--;
               sourceCodeEl.value = history[historyIndex];
               saveState(false);
               detectAndPreview();
           }
           updateHistoryButtons();
       }

       /** Redo operation */
       function redo() {
           if (historyIndex < history.length - 1) {
               historyIndex++;
               sourceCodeEl.value = history[historyIndex];
               saveState(false);
               detectAndPreview();
           }
           updateHistoryButtons();
       }

       /** Save state to LocalStorage (V97 Key) */
       function saveState(updateHistoryFlag = true) {
           const state = {
               source: sourceCodeEl.value,
               rules: rulesJsonEl.value,
               limit: limitToSelectionEl.checked,
               isSimple: isSimpleMode,
               findSimple: findSimpleEl.value,
               replaceSimple: replaceSimpleEl.value,
               regexSimple: regexSimpleEl.checked,
               caseSensitiveSimple: caseSensitiveSimpleEl.checked,
           };
           localStorage.setItem('codeReplacerStateV97', JSON.stringify(state));

           if (updateHistoryFlag) {
                updateHistory(sourceCodeEl.value, true);
           }
       }

       /** Load state from LocalStorage (V97 Key) */
       function loadState() {
           const savedState = localStorage.getItem('codeReplacerStateV97');
           if (savedState) {
               const state = JSON.parse(savedState);
               sourceCodeEl.value = state.source || '';
               rulesJsonEl.value = state.rules || rulesJsonEl.placeholder;
               limitToSelectionEl.checked = state.limit || false;
               
               isSimpleMode = state.isSimple !== undefined ? state.isSimple : true;
               findSimpleEl.value = state.findSimple || 'old_function_call';
               replaceSimpleEl.value = state.replaceSimple || 'new_api_call';
               regexSimpleEl.checked = state.regexSimple || false;
               caseSensitiveSimpleEl.checked = state.caseSensitiveSimple !== undefined ? state.caseSensitiveSimple : true;

               setMode(isSimpleMode ? 'simple' : 'pipeline');

               limitToSelectionEl.setAttribute('aria-checked', limitToSelectionEl.checked);
               
               if (sourceCodeEl.value.length > 0) {
                    history = [sourceCodeEl.value];
                    historyIndex = 0;
               } else {
                    history = [];
                    historyIndex = -1;
               }
           } else {
               findSimpleEl.value = 'old_function_call';
               replaceSimpleEl.value = 'new_api_call';
               caseSensitiveSimpleEl.checked = true;
           }
           updateHistoryButtons();
           handleInputChange();
           sourceCodeEl.focus();
       }

       /** Display status messages */
       function showStatus(message, type) {
           statusMessageEl.textContent = message;
           statusMessageEl.className = 'mt-8 text-center p-4 rounded-lg font-medium text-sm transition-all duration-300 border border-transparent w-full max-w-4xl';
           statusMessageEl.style.boxShadow = 'none';

           statusMessageEl.classList.remove('bg-diff-added', 'text-text-primary', 'border-diff-added', 'bg-diff-removed', 'text-text-primary', 'border-diff-removed', 'bg-bg-secondary', 'text-accent-cyan', 'border-accent-cyan');
           statusMessageEl.style.backgroundColor = '#3B4252';
           statusMessageEl.style.borderColor = '#4C566A';

           switch (type) {
               case 'success':
                   statusMessageEl.style.backgroundColor = 'var(--diff-added)';
                   statusMessageEl.style.color = 'var(--text-light)';
                   statusMessageEl.style.borderColor = '#A3BE8C';
                   statusMessageEl.style.boxShadow = '0 0 10px rgba(163, 190, 140, 0.5)';
                   break;
               case 'error':
                   statusMessageEl.style.backgroundColor = 'var(--diff-removed)';
                   statusMessageEl.style.color = 'var(--text-light)';
                   statusMessageEl.style.borderColor = '#BF616A';
                   statusMessageEl.style.boxShadow = '0 0 10px rgba(191, 97, 106, 0.5)';
                   break;
               case 'info':
               default:
                   statusMessageEl.style.backgroundColor = '#3B4252';
                   statusMessageEl.style.color = 'var(--accent-cyan)';
                   statusMessageEl.style.borderColor = 'var(--accent-cyan)';
                   statusMessageEl.style.boxShadow = '0 0 10px rgba(136, 192, 208, 0.3)';
                   break;
           }
       }

       /** Generates line numbers */
       function generateLineNumbers(code) {
           const lines = code.split('\n');
           const numLines = lines.length;
           
           const lineNumbersHtml = Array.from({ length: numLines }, (_, i) =>
               `<div>${i + 1}</div>`
           ).join('');

           lineNumbersEl.innerHTML = lineNumbersHtml;
       }

       /** Syncs scroll between source and preview */
       function syncScroll(sourceId, targetId) {
           const source = document.getElementById(sourceId);
           const target = document.getElementById(targetId);
           if (!target) return;
           if (source.id === 'sourceCode') {
               target.scrollTop = source.scrollTop;
           } else if (source.id === 'lineNumbersContainer') {
               document.getElementById('sourceCode').scrollTop = source.scrollTop;
           }
       }
       
       /** V9.0: Updates the selection range state */
       function updateSelectionRange() {
           const start = sourceCodeEl.selectionStart;
           const end = sourceCodeEl.selectionEnd;

           selectionRange.start = start;
           selectionRange.end = end;
           
           const selectedText = sourceCodeEl.value.substring(start, end);

           if (start !== end) {
               selectionRangeInfoEl.textContent = `ÁØÑÂúç: ${start} - ${end} (${selectedText.length} Â≠óÂÖÉ).`;
               selectionHintEl.textContent = `(Â∑≤ÈÅ∏ÂÆö: ${selectedText.length} Â≠óÂÖÉ)`;
               limitToSelectionEl.disabled = false;
           } else {
               selectionRangeInfoEl.textContent = 'Êú™ÈÅ∏ÂÆöÁØÑÂúç (No selection yet).';
               selectionHintEl.textContent = '';
               limitToSelectionEl.disabled = true;
               limitToSelectionEl.checked = false;
           }
           limitToSelectionEl.setAttribute('aria-checked', limitToSelectionEl.checked);
           handleInputChange();
       }

       /** Core logic: Detect and generate Diff View (V9.1 - based on first rule) */
       function detectAndPreview() {
           const rules = parseRules();
           let source = sourceCodeEl.value;
           
           matchFound = false;
           findNextButton.disabled = true;
           replaceNextButton.disabled = true;
           
           updateQuotaUI();
           
           allMatches = [];
           currentMatchIndex = 0;

           generateLineNumbers(source);
           previewCodeEl.innerHTML = `<span class="text-text-secondary">${source.length === 0 ? 'Ë´ãËº∏ÂÖ•Á®ãÂºèÁ¢º‰ª•ÈñãÂßãÂÅµÊ∏¨...' : 'Ëº∏ÂÖ•Ë¶èÂâá‰ª•ÂïüÂãïÂÅµÊ∏¨...'}</span>`;

           if (source.length === 0 || !rules || rules.length === 0) {
               showStatus('üí° INIT: Ëº∏ÂÖ•Á®ãÂºèÁ¢ºÂèäË¶èÂâá‰ª•ÂïüÂãïÂÅµÊ∏¨Á®ãÂ∫è...', 'info');
               return;
           }

           // --- Contextual Scope Check ---
           let diffSource = source;
           let offset = 0;
           
           if (limitToSelectionEl.checked && selectionRange.start !== selectionRange.end) {
               diffSource = source.substring(selectionRange.start, selectionRange.end);
               offset = selectionRange.start;
               selectionHintEl.textContent = `(ÈôêÂÆöÁØÑÂúçÊñº ${selectionRange.end - selectionRange.start} Â≠óÂÖÉ)`;
           } else {
                selectionHintEl.textContent = selectionRange.start !== selectionRange.end ? `(Â∑≤ÈÅ∏ÂÆö: ${selectionRange.end - selectionRange.start} Â≠óÂÖÉ)` : '';
           }
           
           // --- DIFF LOGIC (Uses ONLY the FIRST Rule for simplicity in display) ---
           const firstRule = rules[0];
           let regex;
           let flags = 'g';

           if (!firstRule.find) {
                showStatus('‚ùå ERROR: Á¨¨‰∏ÄÊ¢ùË¶èÂâáÊú™ÂåÖÂê´ "find" Ê¨Ñ‰Ωç„ÄÇ', 'error');
                return;
           }

           if (!firstRule.replace) {
                firstRule.replace = "";
           }

           if (firstRule.caseSensitive === false) flags += 'i';

           try {
               if (firstRule.regex === true) {
                   regex = new RegExp(firstRule.find, flags);
               } else {
                   const escapedSegment = firstRule.find
                       .replace(/[.*+?^${}()|[\]\\]/g, '\\$&')
                       .replace(/\n/g, '\\n');
                   regex = new RegExp(escapedSegment, flags);
               }
           } catch (e) {
               previewCodeEl.textContent = source;
               showStatus(`‚ùå REGEX ERROR (Rule 1): Ê≠£Ë¶èË°®ÈÅîÂºèË™ûÊ≥ïÈåØË™§: ${e.message}`, 'error');
               return;
           }

           // Find all matches
           let match;
           allMatches = [];
           while ((match = regex.exec(diffSource)) !== null) {
               const fullMatch = [...match];
               fullMatch.index = match.index + offset;
               allMatches.push(fullMatch);
           }
           
           if (allMatches.length === 0) {
               previewCodeEl.textContent = source;
               showStatus('‚ùå ERROR: Êú™ÂåπÈÖç (No Match)„ÄÇË´ãÊ™¢Êü•Ë¶èÂâá„ÄÇ', 'error');
               return;
           }

           matchFound = true;
           findNextButton.disabled = false;
           replaceNextButton.disabled = false;
           
           // Generate Diff HTML based on the original full source
           let lastIndex = 0;
           let highlightedHtml = '';
           
           const singleMatchRegex = new RegExp(regex.source, regex.flags.replace('g', ''));

           for (let i = 0; i < allMatches.length; i++) {
               const matchInfo = allMatches[i];
               const matchText = matchInfo[0];
               const matchStart = matchInfo.index;
               const matchEnd = matchStart + matchText.length;
               
               highlightedHtml += source.substring(lastIndex, matchStart);
               
               const replacedText = matchText.replace(singleMatchRegex, firstRule.replace);

               const removedHtml = matchText.replace(/\n/g, '‚Üµ<br class="hidden">').replace(/\r/g, '');
               const addedHtml = replacedText.replace(/\n/g, '‚Üµ<br class="hidden">').replace(/\r/g, '');

               if (matchText !== replacedText) {
                   highlightedHtml += `<span class="diff-removed">${removedHtml}</span><span class="diff-added">${addedHtml}</span>`;
               } else {
                   highlightedHtml += `<span class="diff-removed">${removedHtml}</span>`;
               }

               lastIndex = matchEnd;
           }

           highlightedHtml += source.substring(lastIndex);
           
           highlightedHtml = highlightedHtml.replace(/‚Üµ<br class="hidden">/g, '<br>');

           previewCodeEl.innerHTML = highlightedHtml;
           showStatus(`‚úÖ SUCCESS: ÂÅµÊ∏¨Âà∞ ${allMatches.length} ÂÄãÁõ∏Á¨¶Áâ©‰ª∂ (Rule 1)„ÄÇ`, 'success');

           currentMatchIndex = 0;
           scrollToMatch(currentMatchIndex, 'diff-removed');
       }

       /** Scrolls to the N-th match item */
       function scrollToMatch(index, className) {
           const matches = previewCodeEl.querySelectorAll(`.${className}`);
           if (matches.length > 0 && index >= 0 && index < matches.length) {
               const target = matches[index];
               
               previewCodeEl.querySelectorAll('.current-match').forEach(el => {
                   el.classList.remove('current-match');
                   el.style.boxShadow = 'none';
               });

               target.classList.add('current-match');
               target.style.boxShadow = '0 0 10px var(--accent-cyan)';

               requestAnimationFrame(() => {
                   const highlightTop = target.offsetTop;
                   const wrapperHeight = lineNumbersContainerEl.clientHeight;

                   lineNumbersContainerEl.scrollTop = highlightTop - (wrapperHeight / 3);
                   sourceCodeEl.scrollTop = lineNumbersContainerEl.scrollTop;
               });
               
               showStatus(`üîç Ê™¢Ë¶ñ Rule 1 ÂåπÈÖçÈ†Ö ${index + 1} / ${allMatches.length}.`, 'info');
           }
       }

       /** Find Next match */
       function findNext() {
           if (allMatches.length === 0) return;
           currentMatchIndex = (currentMatchIndex + 1) % allMatches.length;
           scrollToMatch(currentMatchIndex, 'diff-removed');
       }

       /** Replace Next match (V9.1 - uses the first rule) */
       function replaceNext() {
           if (allMatches.length === 0) return;
           
           const source = sourceCodeEl.value;
           const matchInfo = allMatches[currentMatchIndex];
           const matchText = matchInfo[0];
           const matchStart = matchInfo.index;
           
           const firstRule = window.parsedRules[0];
           if (!firstRule) return;

           let regex;
           let flags = '';
           if (firstRule.caseSensitive === false) flags += 'i';
           
           try {
               regex = new RegExp(firstRule.find, flags);
           } catch (e) {
               showStatus(`‚ùå REGEX ERROR: ${e.message}`, 'error');
               return;
           }

           let newCode = source.substring(0, matchStart);
           const replacedSegment = matchText.replace(regex, firstRule.replace || "");
           newCode += replacedSegment;
           newCode += source.substring(matchStart + matchText.length);

           sourceCodeEl.value = newCode;
           updateHistory(newCode, true);
           
           detectAndPreview();

           if (allMatches.length > 0) {
                currentMatchIndex = currentMatchIndex % allMatches.length;
                scrollToMatch(currentMatchIndex, 'diff-removed');
           } else {
                showStatus('‚úÖ Rule 1: Â∑≤ÂÆåÊàêÊâÄÊúâÂñÆÊ≠•Âèñ‰ª£„ÄÇ', 'success');
           }
           saveState();
       }


       /** V9.3: Executes the full Multi-Rule Pipeline (or Simple Rule) */
       function performReplacement() {
           
           if (window.quota.isLoaded && window.quota.replacements_left <= 0) {
                showStatus('üö´ ÈÖçÈ°çÁî®Áõ°! Ë´ãÈªûÊìäÂΩàÁ™óÂª£ÂëäÊåâÈàïÁç≤ÂèñÊõ¥Â§öÊ¨°Êï∏„ÄÇ', 'error');
                return;
           }

           const rules = window.parsedRules;
           if (!rules || rules.length === 0) {
               showStatus('üö´ WARNING: Ë¶èÂâáÁÆ°Á∑öÊòØÁ©∫ÁöÑÊàñÁÑ°Êïà„ÄÇ', 'error');
               return;
           }
           
           let currentCode = sourceCodeEl.value;
           let totalReplacements = 0;
           let effectiveSource;
           
           if (limitToSelectionEl.checked && selectionRange.start !== selectionRange.end) {
               effectiveSource = currentCode.substring(selectionRange.start, selectionRange.end);
               showStatus('‚ö†Ô∏è Ë≠¶ÂëäÔºöÊ≠£Âú®ÈôêÂÆöÁØÑÂúçÂÖßÂü∑Ë°åÂèñ‰ª£ÔºåË´ãÊ™¢Êü•ÁµêÊûú„ÄÇ', 'info');
           } else {
               effectiveSource = currentCode;
           }
           
           // --- Execute Pipeline ---
           for (let i = 0; i < rules.length; i++) {
               const rule = rules[i];
               const find = rule.find;
               const replace = rule.replace || "";
               
               let flags = 'g';
               if (rule.caseSensitive === false) flags += 'i';
               
               let regex;
               try {
                   if (rule.regex === true) {
                       regex = new RegExp(find, flags);
                   } else {
                       const escapedSegment = find
                           .replace(/[.*+?^${}()|[\]\\]/g, '\\$&')
                           .replace(/\n/g, '\\n');
                       regex = new RegExp(escapedSegment, flags);
                   }
               } catch (e) {
                   showStatus(`‚ùå REGEX ERROR (Rule ${i + 1}): Ë™ûÊ≥ïÈåØË™§„ÄÇÂÅúÊ≠¢ÁÆ°Á∑ö„ÄÇ`, 'error');
                   return;
               }
               
               const beforeCount = (effectiveSource.match(regex) || []).length;
               effectiveSource = effectiveSource.replace(regex, replace);

               totalReplacements += beforeCount;
           }

           if (totalReplacements > 0) {
                window.decrementQuota();
           }

           // --- Re-integrate into full source code ---
           if (limitToSelectionEl.checked && selectionRange.start !== selectionRange.end) {
               currentCode = currentCode.substring(0, selectionRange.start) +
                             effectiveSource +
                             currentCode.substring(selectionRange.end);
           } else {
               currentCode = effectiveSource;
           }

           sourceCodeEl.value = currentCode;
           updateHistory(currentCode, true);
           detectAndPreview();

           showStatus(`üöÄ ${isSimpleMode ? 'Âèñ‰ª£ÂÆåÊàê' : 'PIPELINE COMPLETE'}: Âü∑Ë°å ${rules.length} Ê¢ùË¶èÂâá„ÄÇÂÖ±Âèñ‰ª£ ${totalReplacements} Ëôï„ÄÇ`, 'success');
           matchFound = false;
           replaceButton.disabled = true;
           saveState();
       }

       // --- Event Listeners and Setup ---
       
       const debouncedDetectAndPreview = debounce(detectAndPreview, 350);

       function handleInputChange() {
           showStatus('üîç DETECTING: Ë¶èÂâáËàáÁ®ãÂºèÁ¢ºÊõ¥Êñ∞‰∏≠...', 'info');
           debouncedDetectAndPreview();
       }

       /** V10.7: Handles the click on the Reward Ad button. (Ad Slot 5/7 - Pop-up Ad 1/2) */
       function handleRewardAdClick() {
            if (!window.quota.isLoaded) {
                showStatus('‚è≥ ÈåØË™§: Ë≥áÊñôÂ∫´Â∞öÊú™ËºâÂÖ•ÂÆåÊàêÔºåË´ãÁ®çÂÄôÂÜçË©¶ (Database not ready).', 'error');
                return;
            }
           
            // --- Âª£Âëä‰Ωç 5/7: ÂΩàÁ™óÂª£ÂëäÂØ¶È´î‰ª£Á¢º (Áî±ÈªûÊìäËß∏Áôº - Á¨¨‰∏ÄÂÄã URL) ---
            // ÈªûÊìäÊ≠§ÊåâÈàïÂæåÔºåÂãïÊÖãËºâÂÖ•‰∏¶Âü∑Ë°åÊÇ®ÁöÑÂ§ñÈÉ®ÂΩàÁ™óËÖ≥Êú¨„ÄÇ
            const scriptEl = document.createElement('script');
            scriptEl.async = true;
            scriptEl.src = 'https://cylindrical-occasion.com/bz3oVU0bP.3Kpivhbem/VlJ/ZwDM0q2XNZzBIw0ZMVzDkH4tLqTxYf3lMsjUQCzAOeTEkx';
            document.body.appendChild(scriptEl);
           
            // Áî±ÊñºÁÑ°Ê≥ïÂÅµÊ∏¨Â§ñÈÉ®ÂΩàÁ™ó/ÈáçÂÆöÂêëÂª£ÂëäÊòØÂê¶ÂÆåÊàêËßÄÁúãÔºåÊàëÂÄëÂú®Ê≠§ËôïÁ´ãÂç≥Êéà‰∫àÈÖçÈ°ç„ÄÇ
            window.grantQuota();
           
            showStatus('‚úÖ ÂΩàÁ™óÂª£Âëä (1/2) Â∑≤ÂòóË©¶ÂïüÂãï„ÄÇËã•ÂΩàÁ™óÊàñÊñ∞ÂàÜÈ†ÅÊú™Âá∫ÁèæÔºåË´ãÂÖÅË®±ÁÄèË¶ΩÂô®ÂΩàÁ™ó„ÄÇÈÖçÈ°çÂ∑≤Êéà‰∫à...', 'success');
       }


       // Replacement Button Click (Triggers Confirmation Modal)
       replaceButton.addEventListener('click', () => {
           if (window.quota.isLoaded && window.quota.replacements_left <= 0) {
                showStatus('üö´ ÈÖçÈ°çÁî®Áõ°! Ë´ãÈªûÊìäÂΩàÁ™óÂª£ÂëäÊåâÈàïÁç≤ÂèñÊõ¥Â§öÊ¨°Êï∏„ÄÇ', 'error');
                return;
           }

           const rulesCount = window.parsedRules ? window.parsedRules.length : 0;
           const actionText = isSimpleMode ? 'Âèñ‰ª£Êìç‰Ωú' : 'Âèñ‰ª£Ë¶èÂâá';
           appModal.querySelector('h3').textContent = '‚ö† Ë≠¶ÂëäÔºöÊúÄÁµÇÁ¢∫Ë™ç';
           appModal.querySelector('p').innerHTML = `Á≥ªÁµ±Â∞áÂü∑Ë°å **${rulesCount} ÂÄã ${actionText}** ‰∏¶Ë¶ÜÂØ´Á®ãÂºèÁ¢º„ÄÇÈÄôÂ∞áÊ∂àËÄó **1 Ê¨°** ÈÖçÈ°ç„ÄÇÊÇ®Á¢∫ÂÆöË¶ÅÂü∑Ë°åÂóéÔºü`;
           
           // Show Confirm/Cancel buttons (Modal now ONLY handles replacement confirmation)

           modalConfirmButton.classList.remove('hidden');
           modalCancelButton.classList.remove('hidden');

           if (rulesCount > 0) {
               appModal.classList.remove('hidden');
           }
       });

       // Modal Confirm (for Replacement)
       modalConfirmButton.addEventListener('click', () => {
           appModal.classList.add('hidden');
           performReplacement();
       });

       // Modal Cancel (for Replacement)
       modalCancelButton.addEventListener('click', () => {
           appModal.classList.add('hidden');
       });

       // Click outside closes if not a confirmation (safety check)
       appModal.addEventListener('click', (e) => {
           if (e.target === appModal) {
                // Only close if it's not the confirmation dialog (i.e., if logic error led to an empty modal)
                if (modalConfirmButton.classList.contains('hidden')) {
                    appModal.classList.add('hidden');
                }
           }
       });
       
       // Assign event handlers to buttons
       grantQuotaAdButton.addEventListener('click', handleRewardAdClick);
       // downloadCode is already assigned in the HTML element's onclick attribute.

       // Sync scrolls
       sourceCodeEl.addEventListener('scroll', () => syncScroll('sourceCode', 'lineNumbersContainer'));
       lineNumbersContainerEl.addEventListener('scroll', () => syncScroll('lineNumbersContainer', 'sourceCode'));

       // Load state on page load
       window.addEventListener('load', loadState);

   </script>
</body>
</html>
